<?php
/**
 * üß™ SCRIPT DE TEST COMPLET - MODULE DEVIS-FACTURE
 * 
 * Ce script teste int√©gralement :
 * - Enum StatutDevis (7 statuts + toutes m√©thodes)
 * - Services m√©tier (ProspectService, CalculService, etc.)
 * - Contr√¥leur DevisController
 * - Workflow complet prospect ‚Üí chantier
 * - Interface et donn√©es
 * 
 * Usage : php artisan tinker < test_complet_devis.php
 */

echo "üöÄ D√âMARRAGE DES TESTS COMPLETS - MODULE DEVIS-FACTURE\n";
echo "=" . str_repeat("=", 60) . "\n\n";

$erreurs = [];
$succes = [];
$warnings = [];

// ====================================================
// üìä PHASE 1 : TESTS ENUM STATUTDEVIS (15min)
// ====================================================

echo "üìä PHASE 1 : TESTS ENUM STATUTDEVIS\n";
echo "-" . str_repeat("-", 40) . "\n";

try {
    echo "‚úì Test 1.1 : Instanciation enum StatutDevis\n";
    
    // Test des 7 statuts obligatoires
    $statutsAttendus = [
        'PROSPECT_BROUILLON' => 'prospect_brouillon',
        'PROSPECT_ENVOYE' => 'prospect_envoye', 
        'PROSPECT_NEGOCIE' => 'prospect_negocie',
        'PROSPECT_ACCEPTE' => 'prospect_accepte',
        'CHANTIER_VALIDE' => 'chantier_valide',
        'FACTURABLE' => 'facturable',
        'FACTURE' => 'facture'
    ];
    
    foreach ($statutsAttendus as $nom => $valeur) {
        $statut = \App\Enums\StatutDevis::from($valeur);
        if ($statut->value !== $valeur) {
            $erreurs[] = "Enum {$nom} : valeur incorrecte";
        } else {
            echo "  ‚úÖ {$nom} : {$valeur}\n";
        }
    }
    
    echo "‚úì Test 1.2 : M√©thodes label() pour tous les statuts\n";
    foreach (\App\Enums\StatutDevis::cases() as $statut) {
        $label = $statut->label();
        if (empty($label)) {
            $erreurs[] = "Label vide pour statut {$statut->value}";
        } else {
            echo "  ‚úÖ {$statut->value} ‚Üí '{$label}'\n";
        }
    }
    
    echo "‚úì Test 1.3 : M√©thodes badgeClass() pour tous les statuts\n";
    foreach (\App\Enums\StatutDevis::cases() as $statut) {
        $badgeClass = $statut->badgeClass();
        if (empty($badgeClass) || !str_contains($badgeClass, 'bg-')) {
            $erreurs[] = "BadgeClass invalide pour {$statut->value}";
        } else {
            echo "  ‚úÖ {$statut->value} ‚Üí classes CSS OK\n";
        }
    }
    
    echo "‚úì Test 1.4 : Logique m√©tier isProspect() et isChantier()\n";
    
    // Test prospects
    $statutsProspects = [
        \App\Enums\StatutDevis::PROSPECT_BROUILLON,
        \App\Enums\StatutDevis::PROSPECT_ENVOYE,
        \App\Enums\StatutDevis::PROSPECT_NEGOCIE,
        \App\Enums\StatutDevis::PROSPECT_ACCEPTE
    ];
    
    foreach ($statutsProspects as $statut) {
        if (!$statut->isProspect() || $statut->isChantier()) {
            $erreurs[] = "Logique prospect incorrecte pour {$statut->value}";
        } else {
            echo "  ‚úÖ {$statut->value} : isProspect() = true\n";
        }
    }
    
    // Test chantiers
    $statutsChantiers = [
        \App\Enums\StatutDevis::CHANTIER_VALIDE,
        \App\Enums\StatutDevis::FACTURABLE,
        \App\Enums\StatutDevis::FACTURE
    ];
    
    foreach ($statutsChantiers as $statut) {
        if ($statut->isProspect() || !$statut->isChantier()) {
            $erreurs[] = "Logique chantier incorrecte pour {$statut->value}";
        } else {
            echo "  ‚úÖ {$statut->value} : isChantier() = true\n";
        }
    }
    
    echo "‚úì Test 1.5 : Workflow - getProchainStatutsPossibles()\n";
    
    // Test transitions critiques
    $transitionsAttendues = [
        'PROSPECT_BROUILLON' => ['PROSPECT_ENVOYE'],
        'PROSPECT_ENVOYE' => ['PROSPECT_NEGOCIE', 'PROSPECT_ACCEPTE'],
        'PROSPECT_ACCEPTE' => ['CHANTIER_VALIDE'],
        'CHANTIER_VALIDE' => ['FACTURABLE'],
        'FACTURABLE' => ['FACTURE'],
        'FACTURE' => []
    ];
    
    foreach ($transitionsAttendues as $statutActuel => $statutsSuivants) {
        $statut = \App\Enums\StatutDevis::from(strtolower($statutActuel));
        $prochains = $statut->getProchainStatutsPossibles();
        
        if (count($prochains) !== count($statutsSuivants)) {
            $erreurs[] = "Nombre transitions incorrect pour {$statutActuel}";
        } else {
            echo "  ‚úÖ {$statutActuel} ‚Üí " . count($statutsSuivants) . " transition(s)\n";
        }
    }
    
    echo "‚úì Test 1.6 : M√©thodes de permission (peutEtreModifie, peutEtreConverti, etc.)\n";
    
    // Test conversion (seul PROSPECT_ACCEPTE peut √™tre converti)
    $peutConvertir = \App\Enums\StatutDevis::PROSPECT_ACCEPTE->peutEtreConverti();
    if (!$peutConvertir) {
        $erreurs[] = "PROSPECT_ACCEPTE devrait pouvoir √™tre converti";
    } else {
        echo "  ‚úÖ PROSPECT_ACCEPTE : peutEtreConverti() = true\n";
    }
    
    // Test modification
    $statutsModifiables = [
        \App\Enums\StatutDevis::PROSPECT_BROUILLON,
        \App\Enums\StatutDevis::PROSPECT_NEGOCIE,
        \App\Enums\StatutDevis::CHANTIER_VALIDE
    ];
    
    foreach ($statutsModifiables as $statut) {
        if (!$statut->peutEtreModifie()) {
            $erreurs[] = "{$statut->value} devrait pouvoir √™tre modifi√©";
        } else {
            echo "  ‚úÖ {$statut->value} : peutEtreModifie() = true\n";
        }
    }
    
    $succes[] = "‚úÖ Enum StatutDevis : 7 statuts + toutes m√©thodes valid√©s";
    
} catch (\Exception $e) {
    $erreurs[] = "‚ùå ERREUR CRITIQUE Enum : " . $e->getMessage();
}

echo "\n";

// ====================================================
// üîß PHASE 2 : TESTS SERVICES M√âTIER (25min)
// ====================================================

echo "üîß PHASE 2 : TESTS SERVICES M√âTIER\n";
echo "-" . str_repeat("-", 40) . "\n";

try {
    echo "‚úì Test 2.1 : Injection des 4 services m√©tier\n";
    
    // Test ProspectService
    try {
        $prospectService = app(\App\Services\ProspectService::class);
        if ($prospectService) {
            echo "  ‚úÖ ProspectService : instanci√© avec succ√®s\n";
        }
    } catch (\Exception $e) {
        $erreurs[] = "‚ùå ProspectService non accessible : " . $e->getMessage();
    }
    
    // Test CalculService  
    try {
        $calculService = app(\App\Services\CalculService::class);
        if ($calculService) {
            echo "  ‚úÖ CalculService : instanci√© avec succ√®s\n";
        }
    } catch (\Exception $e) {
        $erreurs[] = "‚ùå CalculService non accessible : " . $e->getMessage();
    }
    
    // Test ConversionService
    try {
        $conversionService = app(\App\Services\ConversionService::class);
        if ($conversionService) {
            echo "  ‚úÖ ConversionService : instanci√© avec succ√®s\n";
        }
    } catch (\Exception $e) {
        $erreurs[] = "‚ùå ConversionService non accessible : " . $e->getMessage();
    }
    
    // Test NegociationService
    try {
        $negociationService = app(\App\Services\NegociationService::class);
        if ($negociationService) {
            echo "  ‚úÖ NegociationService : instanci√© avec succ√®s\n";
        }
    } catch (\Exception $e) {
        $erreurs[] = "‚ùå NegociationService non accessible : " . $e->getMessage();
    }
    
} catch (\Exception $e) {
    $erreurs[] = "‚ùå ERREUR Services : " . $e->getMessage();
}

try {
    echo "‚úì Test 2.2 : ProspectService - M√©thodes principales\n";
    
    $prospectService = app(\App\Services\ProspectService::class);
    
    // Test getStatistiquesProspects
    try {
        $stats = $prospectService->getStatistiquesProspects();
        if (!is_array($stats)) {
            $erreurs[] = "getStatistiquesProspects() ne retourne pas un array";
        } else {
            $clefsAttendues = ['total', 'prospects', 'chantiers', 'envoye', 'convertibles', 'montant_total'];
            foreach ($clefsAttendues as $clef) {
                if (!array_key_exists($clef, $stats)) {
                    $warnings[] = "Statistique '{$clef}' manquante";
                } else {
                    echo "  ‚úÖ Statistique '{$clef}' : " . ($stats[$clef] ?? 0) . "\n";
                }
            }
        }
    } catch (\Exception $e) {
        $erreurs[] = "‚ùå getStatistiquesProspects() : " . $e->getMessage();
    }
    
} catch (\Exception $e) {
    $erreurs[] = "‚ùå ERREUR ProspectService : " . $e->getMessage();
}

echo "\n";

// ====================================================
// üóÑÔ∏è PHASE 3 : TESTS MOD√àLES ET DONN√âES (15min)
// ====================================================

echo "üóÑÔ∏è PHASE 3 : TESTS MOD√àLES ET DONN√âES\n";
echo "-" . str_repeat("-", 40) . "\n";

try {
    echo "‚úì Test 3.1 : Mod√®le Devis et base de donn√©es\n";
    
    // Compter les devis
    $totalDevis = \App\Models\Devis::count();
    echo "  ‚úÖ Total devis en base : {$totalDevis}\n";
    
    if ($totalDevis > 0) {
        // Tester le premier devis
        $devis = \App\Models\Devis::first();
        
        // Test statut enum
        if ($devis->statut) {
            $statutLabel = $devis->statut->label();
            echo "  ‚úÖ Premier devis - statut : {$statutLabel}\n";
            
            $badgeClass = $devis->statut->badgeClass();
            echo "  ‚úÖ Premier devis - badgeClass : CSS OK\n";
            
            $isProspect = $devis->statut->isProspect();
            echo "  ‚úÖ Premier devis - isProspect : " . ($isProspect ? 'true' : 'false') . "\n";
        } else {
            $warnings[] = "Premier devis sans statut enum";
        }
        
        // Test relations
        if ($devis->commercial) {
            echo "  ‚úÖ Relation commercial : {$devis->commercial->name}\n";
        } else {
            $warnings[] = "Relation commercial manquante";
        }
        
        if ($devis->chantier) {
            echo "  ‚úÖ Relation chantier : {$devis->chantier->titre}\n";
        } else {
            echo "  ‚ÑπÔ∏è  Devis prospect (pas de chantier li√©)\n";
        }
        
        // Test calculs financiers
        if ($devis->montant_ttc !== null) {
            echo "  ‚úÖ Montant TTC : " . number_format($devis->montant_ttc, 2) . " ‚Ç¨\n";
        }
        
        if ($devis->montant_ht !== null) {
            echo "  ‚úÖ Montant HT : " . number_format($devis->montant_ht, 2) . " ‚Ç¨\n";
        }
        
    } else {
        $warnings[] = "Aucun devis en base pour tester";
    }
    
    echo "‚úì Test 3.2 : Mod√®les User (commerciaux)\n";
    
    $totalCommerciaux = \App\Models\User::where('role', 'commercial')->count();
    echo "  ‚úÖ Total commerciaux : {$totalCommerciaux}\n";
    
    echo "‚úì Test 3.3 : Mod√®les Chantier\n";
    
    $totalChantiers = \App\Models\Chantier::count();
    echo "  ‚úÖ Total chantiers : {$totalChantiers}\n";
    
} catch (\Exception $e) {
    $erreurs[] = "‚ùå ERREUR Mod√®les : " . $e->getMessage();
}

echo "\n";

// ====================================================
// üéØ PHASE 4 : TEST WORKFLOW COMPLET (20min)
// ====================================================

echo "üéØ PHASE 4 : TEST WORKFLOW COMPLET\n";
echo "-" . str_repeat("-", 40) . "\n";

try {
    echo "‚úì Test 4.1 : Cr√©ation prospect via ProspectService\n";
    
    $prospectService = app(\App\Services\ProspectService::class);
    
    // Donn√©es de test pour cr√©ation prospect
    $dataProspect = [
        'titre' => 'Test Prospect - Validation Production',
        'client_nom' => 'Client Test Validation',
        'client_email' => 'test.validation@example.com',
        'client_telephone' => '01.23.45.67.89',
        'commercial_id' => 1, // Supposer qu'il y a au moins un commercial
        'lignes' => [
            [
                'designation' => 'Ligne test validation',
                'quantite' => 2,
                'prix_unitaire' => 500.00,
                'unite' => 'unit√©'
            ]
        ]
    ];
    
    try {
        $prospect = $prospectService->creerProspect($dataProspect);
        
        // V√©rifications cr√©ation
        if ($prospect && $prospect->id) {
            echo "  ‚úÖ Prospect cr√©√© - ID : {$prospect->id}\n";
            echo "  ‚úÖ Num√©ro g√©n√©r√© : {$prospect->numero}\n";
            echo "  ‚úÖ Statut initial : {$prospect->statut->label()}\n";
            echo "  ‚úÖ Montant TTC calcul√© : " . number_format($prospect->montant_ttc, 2) . " ‚Ç¨\n";
            
            // Test workflow : Brouillon ‚Üí Envoy√©
            echo "‚úì Test 4.2 : Workflow prospect - Envoi\n";
            try {
                $prospectService->envoyerProspect($prospect);
                $prospect->refresh();
                if ($prospect->statut->value === 'prospect_envoye') {
                    echo "  ‚úÖ Prospect envoy√© - nouveau statut : {$prospect->statut->label()}\n";
                } else {
                    $erreurs[] = "Statut apr√®s envoi incorrect";
                }
            } catch (\Exception $e) {
                $erreurs[] = "‚ùå Erreur envoi prospect : " . $e->getMessage();
            }
            
            // Test workflow : Envoy√© ‚Üí Accept√©
            echo "‚úì Test 4.3 : Workflow prospect - Acceptation\n";
            try {
                $prospectService->accepterProspect($prospect);
                $prospect->refresh();
                if ($prospect->statut->value === 'prospect_accepte') {
                    echo "  ‚úÖ Prospect accept√© - nouveau statut : {$prospect->statut->label()}\n";
                    
                    // Test conversion
                    echo "‚úì Test 4.4 : Conversion prospect ‚Üí chantier\n";
                    
                    // R√©cup√©rer un chantier existant ou cr√©er un test
                    $chantier = \App\Models\Chantier::first();
                    if (!$chantier) {
                        $warnings[] = "Pas de chantier disponible pour tester la conversion";
                    } else {
                        try {
                            $conversionService = app(\App\Services\ConversionService::class);
                            $resultat = $conversionService->convertirProspectEnChantier($prospect, [
                                'chantier_id' => $chantier->id
                            ]);
                            
                            if ($resultat && isset($resultat['devis'])) {
                                $devisChantier = $resultat['devis'];
                                echo "  ‚úÖ Conversion r√©ussie - nouveau devis ID : {$devisChantier->id}\n";
                                echo "  ‚úÖ Statut apr√®s conversion : {$devisChantier->statut->label()}\n";
                                echo "  ‚úÖ Li√© au chantier : {$devisChantier->chantier->titre}\n";
                            } else {
                                $erreurs[] = "Conversion n'a pas retourn√© de r√©sultat valide";
                            }
                        } catch (\Exception $e) {
                            $erreurs[] = "‚ùå Erreur conversion : " . $e->getMessage();
                        }
                    }
                } else {
                    $erreurs[] = "Statut apr√®s acceptation incorrect";
                }
            } catch (\Exception $e) {
                $erreurs[] = "‚ùå Erreur acceptation prospect : " . $e->getMessage();
            }
            
        } else {
            $erreurs[] = "Cr√©ation prospect a √©chou√©";
        }
        
    } catch (\Exception $e) {
        $erreurs[] = "‚ùå Erreur cr√©ation prospect : " . $e->getMessage();
    }
    
} catch (\Exception $e) {
    $erreurs[] = "‚ùå ERREUR WORKFLOW : " . $e->getMessage();
}

echo "\n";

// ====================================================
// üåê PHASE 5 : TESTS CONTR√îLEUR (10min)
// ====================================================

echo "üåê PHASE 5 : TESTS CONTR√îLEUR\n";
echo "-" . str_repeat("-", 40) . "\n";

try {
    echo "‚úì Test 5.1 : Instanciation DevisController\n";
    
    // Simuler instanciation contr√¥leur
    $pdfService = app(\App\Services\PdfService::class);
    $controller = new \App\Http\Controllers\DevisController($pdfService);
    
    if ($controller) {
        echo "  ‚úÖ DevisController instanci√© avec succ√®s\n";
    }
    
    echo "‚úì Test 5.2 : M√©thodes critiques du contr√¥leur disponibles\n";
    
    $methodesAttendues = [
        'globalIndex', 'globalCreate', 'globalStore', 'globalShow',
        'index', 'create', 'store', 'show', 'edit', 'update',
        'prospects', 'convertToChantier', 'downloadPdf'
    ];
    
    foreach ($methodesAttendues as $methode) {
        if (method_exists($controller, $methode)) {
            echo "  ‚úÖ M√©thode {$methode}() : disponible\n";
        } else {
            $erreurs[] = "M√©thode {$methode}() manquante dans DevisController";
        }
    }
    
} catch (\Exception $e) {
    $erreurs[] = "‚ùå ERREUR Contr√¥leur : " . $e->getMessage();
}

echo "\n";

// ====================================================
// üìä PHASE 6 : R√âSULTATS ET RAPPORT FINAL
// ====================================================

echo "üìä PHASE 6 : R√âSULTATS ET RAPPORT FINAL\n";
echo "=" . str_repeat("=", 60) . "\n\n";

// Calcul des scores
$totalTests = count($succes) + count($erreurs) + count($warnings);
$tauxReussite = $totalTests > 0 ? round((count($succes) / $totalTests) * 100, 1) : 0;

echo "üéØ R√âSUM√â EX√âCUTIF\n";
echo "-" . str_repeat("-", 20) . "\n";
echo "‚úÖ Tests r√©ussis     : " . count($succes) . "\n";
echo "‚ùå Erreurs critiques : " . count($erreurs) . "\n";
echo "‚ö†Ô∏è  Avertissements   : " . count($warnings) . "\n";
echo "üìä Taux de r√©ussite  : {$tauxReussite}%\n\n";

if (!empty($succes)) {
    echo "‚úÖ SUCC√àS :\n";
    foreach ($succes as $s) {
        echo "   {$s}\n";
    }
    echo "\n";
}

if (!empty($warnings)) {
    echo "‚ö†Ô∏è  AVERTISSEMENTS :\n";
    foreach ($warnings as $w) {
        echo "   {$w}\n";
    }
    echo "\n";
}

if (!empty($erreurs)) {
    echo "‚ùå ERREURS CRITIQUES :\n";
    foreach ($erreurs as $e) {
        echo "   {$e}\n";
    }
    echo "\n";
}

// D√©cision finale
echo "üèÜ D√âCISION FINALE :\n";
echo "-" . str_repeat("-", 20) . "\n";

if (count($erreurs) === 0) {
    echo "‚úÖ SYST√àME VALID√â POUR LA PRODUCTION !\n";
    echo "   ‚Üí Tous les composants critiques fonctionnent\n";
    echo "   ‚Üí Workflow prospect‚Üíchantier op√©rationnel\n";
    echo "   ‚Üí Enum StatutDevis complet et coh√©rent\n";
    echo "   ‚Üí Services m√©tier accessibles\n\n";
    echo "üöÄ Le module devis-facture est pr√™t pour la mise en production !\n";
} elseif (count($erreurs) <= 2 && count($warnings) <= 5) {
    echo "üîÑ CORRECTIONS MINEURES REQUISES\n";
    echo "   ‚Üí Quelques ajustements n√©cessaires avant production\n";
    echo "   ‚Üí Fonctionnalit√©s principales op√©rationnelles\n";
    echo "   ‚Üí Pas de blocage majeur identifi√©\n\n";
    echo "‚è∞ Estimation correction : 1-2 heures\n";
} else {
    echo "‚ùå RETOUR EN D√âVELOPPEMENT N√âCESSAIRE\n";
    echo "   ‚Üí Erreurs critiques d√©tect√©es\n";
    echo "   ‚Üí Composants essentiels non fonctionnels\n";
    echo "   ‚Üí Tests approfondis requis\n\n";
    echo "‚è∞ Ne pas d√©ployer en production\n";
}

echo "\n" . str_repeat("=", 60) . "\n";
echo "üß™ Tests termin√©s - " . date('Y-m-d H:i:s') . "\n";
echo "üë®‚Äçüíª Rapport g√©n√©r√© automatiquement\n";
echo str_repeat("=", 60) . "\n";

// Retourner le statut pour usage programmatique
return [
    'succes' => count($succes),
    'erreurs' => count($erreurs), 
    'warnings' => count($warnings),
    'taux_reussite' => $tauxReussite,
    'validation_production' => count($erreurs) === 0,
    'details' => [
        'succes' => $succes,
        'erreurs' => $erreurs,
        'warnings' => $warnings
    ]
];